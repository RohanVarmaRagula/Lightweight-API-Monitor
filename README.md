# Lightweight API Monitor (LAM) Overview
Lightweight API Monitor (LAM) is a developer-focused API observability platform for FastAPI/Starlette applications (shall be expanded to other applications soon).

LAM provides:
- Real-time dashboards
- Request latency tracking
- Error rate monitoring
- Historical performance analytics
- API key based multi-project monitoring

# Local Setup
## Prerequisites (tested on these)
1. PostgreSQL 14+ installed and running.
2. Python 3.9+
3. Node.js 16+
4. Your target FastAPI/Starlette application
## Backend setup
Start from root folder of the repository
### 1. Create a virtual environment and install dependencies
```
# windows
cd backend
python -m venv myvenv
myvenv/Scripts/activate
pip install -r requirements.txt # this installs the SDK also
```
### 2. Set environment variables
Create a file named `.env` in the root folder of the repository (make sure `.gitignore` has `.env`)
Paste the following block and modify the variables according to your use.
```
DB_NAME="your-db-name"
DB_USER="your-db-user"
DB_PASS="your-password"
DB_HOST="your-db-host" # use 'localhost' if postgres is running locally
DB_PORT="your-db-port-number"
JWT_SECRET_KEY="your-secret-key" # a random 32 byte string used to generate jwt tokens in the backend.
VITE_API_BASE_URL="base-url-of-fastapi-server" 
```
Unique JWT secret key can be generated by 
```
python -c "import secrets; print(secrets.token_hex(32))"
```
### 3. Create the database
```
python database/init_db.py
```
You can open your postgres GUI or psql and check if the database with above settings is created or not, if not created already.
### 4. Run the server
```
uvicorn main:app --reload
```

## Frontend setup
Start from root folder
```
cd frontend
npm install
npm run dev
```

# How to use in your FastAPI/Starlette Application
## 1. Install the middleware
First download our middleware that is responsible for collecting the metrics.
```
pip install lam_middleware
```
## 2. Get LAM API Key
- Go to dashboard at `http://localhost:5173`
- Sign up / Log in
- Create a new project
- Navigate to "API Keys" -> Generate new key
- Add to your `.env` as `LAM_API_KEY="your-api-key"`
## 3. Integrate the middleware
LAMMiddleware captures:
- request method
- path
- latency
- status code

Now, you need to add this middleware to your FastAPI app. For example, 
```
from fastapi import FastAPI
from lam_middleware import LAMMiddleware
import os

app = FastAPI()

# add our middleware
app.add_middleware(
    LAMMiddleware,
    api_key=os.getenv("LAM_API_KEY") # make sure .env has this env var 
)

@app.get("/users")
def get_users():
    return {"users":[]}
```

### Advanced Options
You can also exclude paths/endpoints from monitoring. For example,
```
app.add_middleware(
    LAMMiddleware,
    api_key=os.getenv("LAM_API_KEY"),
    exclude_raw_paths={"/health", "/docs"},
    exclude_path_templates={"/health"}
)
```
- `raw_paths` are the complete endpoints of a request.
- `path_templates` are the paths that have sub paths. So, if you exclude a path_template, every endpoint that is a sub path of it will be exclude.

## 4. Monitor
Done. All of the API requests that your app recieves are monitored and analysed in our dashboard. 

# Architecture
```
FastAPI App
    |
LAM Middleware
    |
LAM Backend (/ingest)
    |
PostgreSQL
    |
Dashboard
```

# Deployment
Still under development, will be deployed soon ...

# Notes to developer and future improvements
1. When deploying, re-publish the middleware because it has `INGEST_API_URL = "http://127.0.0.1:8000/ingest"` in it.
2. Add docs in the frontend
3. Add mail alerting
4. Add subscription scheme
5. Add advanced graphs (filter by endpoints, date-range, etc.)
6. Track API usage based on location 
7. Make UI responsive
8. Add option to revoke api key
9. 